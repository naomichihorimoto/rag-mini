<div class="container" style="padding: 2rem 1rem;">
  <div style="max-width: 800px; margin: 0 auto;">
    <h1 style="font-size: 2rem; font-weight: bold; color: #333; margin-bottom: 2rem;">ğŸ¤– AIå›ç­”</h1>

    <!-- è³ªå•è¡¨ç¤º -->
    <div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
      <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: white;">ğŸ“ ã‚ãªãŸã®è³ªå•</h2>
      <p style="font-size: 1.1rem; margin: 0; line-height: 1.6;"><%= @search_query %></p>
    </div>

    <!-- AIå›ç­” -->
    <div class="card" style="margin-bottom: 2rem; border-left: 4px solid #10b981;">
      <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: #10b981;">ğŸ¤– AIå›ç­”</h2>
      
      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
      <div id="loading-indicator" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
        <div style="width: 20px; height: 20px; border: 2px solid #10b981; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <span style="color: #666;">AIãŒå›ç­”ã‚’ç”Ÿæˆä¸­...</span>
      </div>
      
      <!-- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å›ç­”è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="ai-answer" style="font-size: 1rem; line-height: 1.7; color: #333; min-height: 50px; border: 1px solid #e5e5e5; padding: 1rem; border-radius: 0.5rem; background: #fafafa;">
      </div>

      <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="error-message" style="display: none; color: #dc2626; background: #fef2f2; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
      </div>
    </div>

    <!-- å‚è€ƒæ–‡æ›¸ -->
    <div id="reference-documents" class="card" style="margin-bottom: 2rem; display: none;">
      <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: #333;">ğŸ“š å‚è€ƒã«ã—ãŸæ–‡æ›¸</h3>
      <div id="documents-list"></div>
    </div>

    <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
      <%= link_to "â† æˆ»ã‚‹", documents_path, class: "btn btn-secondary" %>

      <%= form_with url: answer_documents_path, method: :get, style: "display: inline-block;" do |f| %>
        <%= f.hidden_field :q, value: @search_query %>
        <%= f.submit "ğŸ”„ å†ç”Ÿæˆ", class: "btn btn-primary" %>
      <% end %>

      <%= link_to "ğŸ“„ æ¤œç´¢çµæœã‚’è¦‹ã‚‹", search_documents_path(q: @search_query), class: "btn btn-secondary" %>
    </div>

    <!-- æ–°ã—ã„è³ªå•ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="card" style="margin-top: 2rem; background: #f8fafc;">
      <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: #333;">ğŸ’­ æ–°ã—ã„è³ªå•ã‚’ã™ã‚‹</h3>

      <%= form_with url: answer_documents_path, method: :get, style: "display: flex; gap: 1rem;" do |f| %>
        <%= f.text_field :q,
              placeholder: "ä»–ã«è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
              class: "form-control",
              style: "flex: 1;" %>
        <%= f.submit "ğŸ¤– AIå›ç­”", class: "btn btn-primary" %>
      <% end %>
    </div>
  </div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.fade-in {
  animation: fadeIn 0.3s ease-in;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const query = '<%= j(@search_query) %>';
  
  if (query) {
    startStreamingAnswer(query);
  }
});

function startStreamingAnswer(query) {
  const loadingIndicator = document.getElementById('loading-indicator');
  const aiAnswerDiv = document.getElementById('ai-answer');
  const errorDiv = document.getElementById('error-message');
  const referenceDocsDiv = document.getElementById('reference-documents');
  
  // DOMè¦ç´ ã®å–å¾—ç¢ºèª
  console.log('DOM elements check:');
  console.log('loadingIndicator:', loadingIndicator);
  console.log('aiAnswerDiv:', aiAnswerDiv);
  console.log('errorDiv:', errorDiv);
  console.log('referenceDocsDiv:', referenceDocsDiv);
  
  if (!aiAnswerDiv) {
    console.error('ai-answer element not found!');
    return;
  }
  
  // åˆæœŸçŠ¶æ…‹ã®è¨­å®š
  loadingIndicator.style.display = 'flex';
  aiAnswerDiv.textContent = '';
  errorDiv.style.display = 'none';
  referenceDocsDiv.style.display = 'none';
  
  // ã‚¿ã‚¤ãƒãƒ¼ãƒ†ã‚¹ãƒˆï¼ˆã‚ˆã‚Šè¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ãï¼‰
  console.log('Starting timer test...');
  let testText = '';
  let counter = 0;
  
  // æœ€åˆã«ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
  aiAnswerDiv.style.backgroundColor = '#ffff99';
  aiAnswerDiv.style.border = '2px solid red';
  aiAnswerDiv.style.fontSize = '20px';
  aiAnswerDiv.style.color = 'red';
  aiAnswerDiv.style.padding = '20px';
  aiAnswerDiv.style.margin = '10px';
  aiAnswerDiv.style.display = 'block';
  aiAnswerDiv.style.visibility = 'visible';
  aiAnswerDiv.style.opacity = '1';
  aiAnswerDiv.style.position = 'relative';
  aiAnswerDiv.style.zIndex = '9999';
  aiAnswerDiv.style.minHeight = '100px';
  aiAnswerDiv.style.width = '100%';
  
  const testInterval = setInterval(() => {
    counter++;
    testText += `ãƒãƒ£ãƒ³ã‚¯${counter} `;
    
    // è¤‡æ•°ã®æ–¹æ³•ã§DOMæ›´æ–°ã‚’è©¦ã™
    aiAnswerDiv.textContent = testText;
    aiAnswerDiv.innerHTML = testText;
    
    console.log(`Timer test ${counter}: ${testText}`);
    console.log('Current aiAnswerDiv content:', aiAnswerDiv.textContent);
    console.log('Current aiAnswerDiv innerHTML:', aiAnswerDiv.innerHTML);
    
    // è¦ç´ ã®çŠ¶æ…‹ã‚’ãƒ‡ãƒãƒƒã‚°
    const computedStyle = window.getComputedStyle(aiAnswerDiv);
    console.log('Element dimensions:', {
      width: aiAnswerDiv.offsetWidth,
      height: aiAnswerDiv.offsetHeight,
      display: computedStyle.display,
      visibility: computedStyle.visibility,
      opacity: computedStyle.opacity,
      color: computedStyle.color,
      backgroundColor: computedStyle.backgroundColor,
      position: computedStyle.position,
      top: computedStyle.top,
      left: computedStyle.left,
      zIndex: computedStyle.zIndex
    });
    
    // è¦ç´ ã®ä½ç½®ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¢ºèª
    const rect = aiAnswerDiv.getBoundingClientRect();
    console.log('Element position:', {
      top: rect.top,
      left: rect.left,
      bottom: rect.bottom,
      right: rect.right,
      inViewport: rect.top >= 0 && rect.left >= 0 && rect.bottom <= window.innerHeight && rect.right <= window.innerWidth
    });
    
    // å¼·åˆ¶çš„ã«å†æç”»ã‚’ãƒˆãƒªã‚¬ãƒ¼
    aiAnswerDiv.style.display = 'none';
    aiAnswerDiv.offsetHeight; // ãƒªãƒ•ãƒ­ãƒ¼å¼·åˆ¶
    aiAnswerDiv.style.display = 'block';
    
    if (counter >= 5) {
      clearInterval(testInterval);
      console.log('Timer test completed, starting real streaming...');
      
      setTimeout(() => {
        // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å…ƒã«æˆ»ã™
        console.log('Resetting styles and starting actual streaming...');
        aiAnswerDiv.style.backgroundColor = '';
        aiAnswerDiv.style.border = '';
        aiAnswerDiv.style.fontSize = '';
        aiAnswerDiv.style.color = '';
        aiAnswerDiv.style.padding = '';
        aiAnswerDiv.style.margin = '';
        aiAnswerDiv.style.display = '';
        aiAnswerDiv.style.visibility = '';
        aiAnswerDiv.style.opacity = '';
        aiAnswerDiv.style.position = '';
        aiAnswerDiv.style.zIndex = '';
        aiAnswerDiv.style.minHeight = '';
        aiAnswerDiv.style.width = '';
        aiAnswerDiv.textContent = '';
        
        console.log('Styles reset, aiAnswerDiv element:', aiAnswerDiv);
        console.log('Starting actual streaming with query:', query);
        startActualStreaming(query);
      }, 2000);
    }
  }, 500);
}

function startActualStreaming(query) {
  const loadingIndicator = document.getElementById('loading-indicator');
  const aiAnswerDiv = document.getElementById('ai-answer');
  const errorDiv = document.getElementById('error-message');
  const referenceDocsDiv = document.getElementById('reference-documents');
  
  const eventSource = new EventSource('/documents/stream_answer?q=' + encodeURIComponent(query));
  let answerText = '';
  
  eventSource.onmessage = function(event) {
    console.log('SSE message received:', event.data);
    
    try {
      const data = JSON.parse(event.data);
      console.log('Parsed SSE data:', data);
      console.log('Data type:', data.type);
      
      switch (data.type) {
        case 'documents':
          console.log('Processing documents:', data.data);
          displayReferenceDocuments(data.data);
          referenceDocsDiv.style.display = 'block';
          break;
          
        case 'answer_start':
          console.log('Answer start received');
          loadingIndicator.style.display = 'none';
          break;
          
        case 'data':
          console.log('Data chunk received:', data);
          console.log('Current answerText length before:', answerText.length);
          
          if (answerText.length === 0) {
            console.log('First chunk, hiding loading indicator');
            loadingIndicator.style.display = 'none';
          }
          
          if (data.content) {
            console.log('Adding content:', data.content);
            answerText += data.content;
            
            console.log('Total answerText now:', answerText);
            console.log('Setting aiAnswerDiv innerHTML to:', answerText.replace(/\n/g, '<br>'));
            
            // requestAnimationFrameã‚’ä½¿ã£ã¦å¼·åˆ¶çš„ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            requestAnimationFrame(() => {
              aiAnswerDiv.innerHTML = answerText.replace(/\n/g, '<br>');
              
              // ã•ã‚‰ã«å¼·åˆ¶çš„ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ä¿ƒã™
              aiAnswerDiv.style.transform = 'translateZ(0)'; // GPUå±¤ã‚’ä½œæˆ
              
              // åˆ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼šsetTimeoutã§ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’åˆ†ã‘ã‚‹
              setTimeout(() => {
                aiAnswerDiv.innerHTML = answerText.replace(/\n/g, '<br>');
                console.log('Updated via setTimeout');
              }, 0);
              
              // æ›´æ–°å¾Œã®çŠ¶æ…‹ç¢ºèª
              console.log('aiAnswerDiv innerHTML after update:', aiAnswerDiv.innerHTML);
              console.log('aiAnswerDiv textContent after update:', aiAnswerDiv.textContent);
            });
            
            console.log('Updated text length:', answerText.length);
          } else {
            console.log('No content in data chunk');
          }
          
          if (data.final) {
            console.log('Final chunk received, closing connection');
            eventSource.close();
          }
          break;
          
        case 'answer_complete':
          eventSource.close();
          break;
          
        case 'error':
          showError(data.message);
          eventSource.close();
          break;
      }
    } catch (e) {
      console.error('Error parsing SSE data:', e);
    }
  };
  
  eventSource.onerror = function(event) {
    console.error('EventSource error:', event);
    showError('æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    eventSource.close();
  };
}

function displayReferenceDocuments(documents) {
  const documentsListDiv = document.getElementById('documents-list');
  
  documentsListDiv.innerHTML = documents.map((doc, index) => `
    <div style="border: 1px solid #e5e5e5; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; background: #f9f9f9;">
      <h4 style="font-size: 1rem; font-weight: 600; margin: 0 0 0.75rem 0;">
        <a href="/documents/${doc.id}" style="color: #3b82f6; text-decoration: none;">
          ğŸ“„ ${escapeHtml(doc.title)}
        </a>
      </h4>
      <p style="color: #666; margin: 0; font-size: 0.9rem; line-height: 1.5;">
        ${escapeHtml(doc.content)}
      </p>
    </div>
  `).join('');
}

function showError(message) {
  const loadingIndicator = document.getElementById('loading-indicator');
  const errorDiv = document.getElementById('error-message');
  
  loadingIndicator.style.display = 'none';
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>